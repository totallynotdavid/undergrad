<!doctype html>
<html lang="es">
   <head>
      <meta charset="UTF-8"/>
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>Eventos Sísmicos</title>
      <script src="https://cdn.tailwindcss.com"></script>
   </head>
   <body class="bg-gray-50 text-gray-800">
      <div class="container mx-auto px-4 py-8">
         <header class="text-center mb-8">
            <h1 class="text-3xl font-bold">Lab. 03: Procesamiento de Señales Sísmicas</h1>
         </header>

         <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6 bg-gray-100 border-b border-gray-200">
               <div class="flex flex-col gap-4">
                  <div class="flex flex-wrap gap-4 justify-between items-center">
                     <!-- Sensor Filters -->
                     <div class="flex-grow">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Sensores</h3>
                        <div class="flex flex-wrap gap-2">
                           {% for sensor in available_sensors %}
                           <a href="/?{% for s in selected_sensors %}{% if s != sensor %}sensors={{ s }}&{% endif %}{% endfor %}{% if sensor not in selected_sensors %}sensors={{ sensor }}&{% endif %}components={{ selected_components|join('&components=') }}&filter_stations={{ filter_stations|lower }}" 
                              class="px-3 py-1 rounded-full text-sm 
                              {% if sensor in selected_sensors %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-blue-100{% endif %}">
                              {{ sensor }}
                           </a>
                           {% endfor %}
                        </div>
                     </div>

                     <!-- Component Filters -->
                     <div class="flex-grow">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Componentes</h3>
                        <div class="flex flex-wrap gap-2">
                           {% for component in available_components %}
                           <a href="/?sensors={{ selected_sensors|join('&sensors=') }}&{% for c in selected_components %}{% if c != component %}components={{ c }}&{% endif %}{% endfor %}{% if component not in selected_components %}components={{ component }}&{% endif %}filter_stations={{ filter_stations|lower }}"
                              class="px-3 py-1 rounded-full text-sm
                              {% if component in selected_components %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-blue-100{% endif %}">
                              {{ component }}
                           </a>
                           {% endfor %}
                        </div>
                     </div>

                     <!-- Multi-file Station Filter -->
                     <div>
                        <a href="/?sensors={{ selected_sensors|join('&sensors=') }}&components={{ selected_components|join('&components=') }}&filter_stations={% if filter_stations %}false{% else %}true{% endif %}"
                           class="inline-flex items-center px-4 py-2 border 
                           {% if filter_stations %}border-blue-600 bg-blue-600 text-white{% else %}border-gray-300 bg-white text-gray-700 hover:bg-gray-100{% endif %} 
                           rounded-md text-sm font-medium focus:outline-none">
                           <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                           </svg>
                           Mostrar solo estaciones múltiples
                        </a>
                     </div>
                  </div>

                  <!-- Selected Filters Summary -->
                  <div class="flex flex-wrap gap-2 items-center" id="selected-filters">
                     {% if selected_sensors or selected_components or filter_stations %}
                     <span class="text-sm font-medium text-gray-600 mr-2">Filtros aplicados:</span>
                     {% for sensor in selected_sensors %}
                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs inline-flex items-center">
                        Sensor: {{ sensor }}
                        <a href="/?{% for s in selected_sensors %}{% if s != sensor %}sensors={{ s }}&{% endif %}{% endfor %}components={{ selected_components|join('&components=') }}&filter_stations={{ filter_stations|lower }}" class="ml-2">
                           <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        </a>
                     </span>
                     {% endfor %}
                     {% for component in selected_components %}
                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs inline-flex items-center">
                        Componente: {{ component }}
                        <a href="/?sensors={{ selected_sensors|join('&sensors=') }}&{% for c in selected_components %}{% if c != component %}components={{ c }}&{% endif %}{% endfor %}filter_stations={{ filter_stations|lower }}" class="ml-2">
                           <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        </a>
                     </span>
                     {% endfor %}
                     {% if filter_stations %}
                     <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs inline-flex items-center">
                        Solo estaciones múltiples
                        <a href="/?sensors={{ selected_sensors|join('&sensors=') }}&components={{ selected_components|join('&components=') }}&filter_stations=false" class="ml-2">
                           <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        </a>
                     </span>
                     {% endif %}
                     <a href="/" class="ml-2 text-sm text-blue-600 hover:text-blue-800">Limpiar todos los filtros</a>
                     {% endif %}
                  </div>
               </div>
            </div>

            <!-- Station Content -->
            <div class="p-6">
               <h2 class="text-xl font-semibold mb-4 text-gray-700">Estaciones: 
                  <span class="text-sm text-gray-500">({{ estaciones|length }} estaciones encontradas)</span>
               </h2>
               <div id="station-content" class="space-y-6">
                  {% if not estaciones %}
                  <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg text-center">
                     No se encontraron estaciones con los filtros seleccionados.
                  </div>
                  {% else %}
                  {% for estacion, archivos in estaciones.items() %}
                  <section class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                     <div class="px-4 py-3 bg-gray-100 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-700">{{ estacion }}</h3>
                        <span class="text-sm text-gray-500">{{ archivos|length }} archivos</span>
                     </div>
                     <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for archivo in archivos %}
                        <div class="file-item flex items-center bg-gray-50 p-3 rounded-lg shadow-sm transition-all duration-300 hover:shadow-md hover:scale-105">
                           <img src="{{ url_for('serve_image', filename=archivo) }}" alt="{{ archivo }}"
                              class="w-16 h-16 mr-4 rounded-md object-cover cursor-pointer"/>
                           <div class="flex-1">
                              <p class="text-sm font-medium truncate">{{ archivo }}</p>
                           </div>
                           <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked/>
                        </div>
                        {% endfor %}
                     </div>
                  </section>
                  {% endfor %}
                  {% endif %}
               </div>
            </div>

            <!-- Apply Changes Button -->
            <div class="p-4 bg-gray-100 border-t border-gray-200 flex justify-end">
               <button id="apply-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                  Aplicar cambios
               </button>
            </div>
         </div>
      </div>

      <!-- Image Modal -->
      <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden">
         <div class="relative bg-white p-4 rounded-lg max-w-4xl max-h-full">
            <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-black text-3xl">&times;</button>
            <img id="modal-image" src="" alt="Expanded view" class="max-w-full max-h-[80vh] object-contain"/>
         </div>
      </div>

      <script>
         document.querySelectorAll('.file-item img').forEach(img => {
             img.addEventListener('click', () => {
                 const modal = document.getElementById('image-modal');
                 const modalImage = document.getElementById('modal-image');
                 modalImage.src = img.src;
                 modal.classList.remove('hidden');
             });
         });

         document.getElementById("close-modal").addEventListener("click", () =>{
                 document.getElementById('image-modal').classList.add('hidden');
         });

         document.getElementById('apply-button').addEventListener('click', () => {
             const data = {};
             document.querySelectorAll('section').forEach(section => {
                 const stationName = section.querySelector('h3').textContent.trim();
                 data[stationName] = {};

                 section.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                     const fileName = checkbox.parentElement.querySelector('p').textContent.trim();
                     data[stationName][fileName] = checkbox.checked ? 'keep' : 'delete';
                 });
             });

             fetch('/apply_changes', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify(data)
             }).then(response => {
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${ response.status }`);
                 }
                 return response.json();
             }).then(data => {
                 alert(data.message);
                 location.reload();
             }).catch(error => {
                 console.error('Error applying changes:', error);
                 alert("Ocurrió un error al aplicar los cambios.");
             });
         });
      </script>
   </body>
</html>